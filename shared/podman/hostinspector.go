// SPDX-FileCopyrightText: 2024 SUSE LLC
//
// SPDX-License-Identifier: Apache-2.0

package podman

import (
	"os"

	"github.com/rs/zerolog"
	. "github.com/uyuni-project/uyuni-tools/shared/l10n"
	"github.com/uyuni-project/uyuni-tools/shared/types"
	"github.com/uyuni-project/uyuni-tools/shared/utils"
)

// HostInspector inspects either the proxy or the server hosts.
type HostInspector struct {
	utils.BaseInspector
}

// NewHostInspector creates a new HostInspector generating the inspection script and data in scriptDir.
func NewHostInspector(scriptDir string) HostInspector {
	base := utils.BaseInspector{
		Values: []types.InspectData{
			types.NewInspectData(
				"scc_username",
				"cat /etc/zypp/credentials.d/SCCcredentials 2>&1 /dev/null | grep username | cut -d= -f2 || true"),
			types.NewInspectData(
				"scc_password",
				"cat /etc/zypp/credentials.d/SCCcredentials 2>&1 /dev/null | grep password | cut -d= -f2 || true"),

			types.NewInspectData(
				"has_uyuni_server",
				"systemctl list-unit-files uyuni-server.service >/dev/null && echo true || echo false"),
		},
		ScriptDir: scriptDir,
	}
	return HostInspector{
		BaseInspector: base,
	}
}

// HostInspectData are the data returned by the host inspector.
type HostInspectData struct {
	SccUsername    string `mapstructure:"scc_username"`
	SccPassword    string `mapstructure:"scc_password"`
	HasUyuniServer bool   `mapstructure:"has_uyuni_server"`
}

// ReadInspectData parses the data generated by the host inspector.
func (i *HostInspector) ReadInspectData() (*HostInspectData, error) {
	return utils.ReadInspectData[HostInspectData](i.GetDataPath())
}

// InspectHost gathers data on the host where to install the server or proxy.
func InspectHost() (*HostInspectData, error) {
	scriptDir, err := os.MkdirTemp("", "mgradm-*")
	defer os.RemoveAll(scriptDir)
	if err != nil {
		return nil, utils.Errorf(err, L("failed to create temporary directory"))
	}

	inspector := NewHostInspector(scriptDir)
	if err := inspector.GenerateScript(); err != nil {
		return nil, err
	}

	if err := utils.RunCmdStdMapping(zerolog.DebugLevel, inspector.GetScriptPath()); err != nil {
		return nil, utils.Errorf(err, L("failed to run inspect script in host system"))
	}

	inspectResult, err := inspector.ReadInspectData()
	if err != nil {
		return nil, utils.Errorf(err, L("cannot inspect host data"))
	}

	return inspectResult, err
}
